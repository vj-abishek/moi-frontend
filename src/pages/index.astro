---
import { Image } from 'astro:assets';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';
import { SITE_DESCRIPTION, SITE_TITLE_HOME, FEATURES, HOW_IT_WORKS, getAppUrl } from '../consts';
import { generateSoftwareApplicationSchema, generateVideoObjectSchema, generateWebPageSchema } from '../seo';
import thumb from '../assets/thumb.jpg';
import heroImage from '../assets/blog/qr-wedding-card-guide/blog-image.png';

const signupUrl = getAppUrl('/signup', Astro.url);
const canonicalUrl = new URL(Astro.url.pathname, Astro.site).toString();
const videoContentUrl = new URL('/intro.mp4', Astro.site).toString();
const videoThumbnailUrl = new URL(thumb.src, Astro.site).toString();

const softwareAppSchema = generateSoftwareApplicationSchema();
const webPageSchema = generateWebPageSchema(
  canonicalUrl,
  SITE_TITLE_HOME,
  SITE_DESCRIPTION
);
const videoSchema = generateVideoObjectSchema(canonicalUrl, videoContentUrl, {
  name: 'Moi – How to track wedding & celebration gifts in 1 minute',
  description: 'Quick intro to Moi: create an event, share one link with guests, track UPI and cash contributions in real time. No spreadsheets.',
  thumbnailUrl: videoThumbnailUrl,
  duration: 'PT1M',
});

// Top 3 benefits for hero / social proof
const BENEFITS = FEATURES.slice(0, 3);
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead 
      title={SITE_TITLE_HOME} 
      description={SITE_DESCRIPTION} 
      schema={[softwareAppSchema, webPageSchema, videoSchema]}
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,400;0,9..144,600;0,9..144,700;1,9..144,400&display=swap" rel="stylesheet" />
  </head>
  <body class="min-h-screen flex flex-col bg-base-100 font-sans">
    <Header />

    <main class="flex-1">
      <!-- Hero -->
      <section id="hero-section" class="relative flex flex-col justify-center transition-all duration-300 mx-4 md:mx-8 xl:mx-auto max-w-7xl mt-4 md:mt-6 rounded-3xl md:rounded-[2.5rem] overflow-hidden min-h-[70vh] md:min-h-[85vh] shadow-2xl shadow-base-300/50">
        <div class="absolute inset-0 z-0">
          <Image 
            src={heroImage} 
            alt="Moi Hero Background" 
            width={1920}
            height={1080}
            class="w-full h-full object-cover"
            loading="eager"
          />
          <div class="absolute inset-0 bg-black/50 bg-gradient-to-t from-black/80 via-black/40 to-black/40"></div>
        </div>

        <div class="max-w-4xl mx-auto px-6 py-24 relative z-10 text-center flex-1 flex flex-col justify-center items-center">
          <p class="hidden sm:block sm:text-xs uppercase sm:tracking-[0.25em] text-white/80 font-bold sm:mb-6" style="font-family: var(--font-moi-display), 'Fraunces', serif;">
            Gift tracking for weddings & celebrations
          </p>
          <h1 class="text-[2.5rem] sm:text-5xl md:text-[5rem] font-bold tracking-tight leading-[1.1] md:leading-[1.05] mb-4 sm:mb-6 text-white drop-shadow-lg" style="font-family: var(--font-moi-display), 'Fraunces', serif;">
            Track every contribution.<br />
            <span class="text-primary italic font-normal">Never miss a மொய்.</span>
          </h1>
          <p class="text-base md:text-xl font-medium tracking-wide text-white/90 drop-shadow leading-relaxed mb-10 max-w-2xl mx-auto text-balance">
            One link. Real-time totals. No spreadsheets.
          </p>
          <div class="flex flex-col sm:flex-row gap-4 justify-center w-full sm:w-auto">
            <a
              href={signupUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center justify-center px-8 py-4 bg-primary text-primary-content font-bold text-sm uppercase tracking-wider hover:bg-primary/90 transition-all hover:scale-[1.02] shadow-xl"
            >
              Get started free
            </a>
            <a
              href="#how-it-works"
              class="inline-flex items-center justify-center px-8 py-4 border border-white/30 text-white text-sm font-semibold hover:border-white hover:bg-white/10 transition-colors backdrop-blur-sm shadow-xl"
            >
              See how it works
            </a>
          </div>
        </div>

        <dialog id="intro-video-modal" class="backdrop:bg-black/70 bg-transparent p-0 border-none w-full max-w-none">
          <div class="min-h-screen w-full px-4 py-10 flex items-center justify-center">
            <div id="intro-video-dialog-content" class="relative w-full max-w-4xl bg-base-100 border border-base-300 shadow-2xl overflow-hidden">
              <!-- Loading state: shown until video is ready (no src on initial load = no request = faster page) -->
              <div id="intro-video-loading" class="absolute inset-0 flex flex-col items-center justify-center gap-4 bg-base-200 min-h-[280px]" aria-live="polite">
                <span class="loading loading-spinner loading-lg text-primary" aria-hidden="true"></span>
                <p class="text-sm text-base-content/60">Loading video…</p>
              </div>
              <video id="intro-video-player" class="w-full h-auto relative z-10 opacity-0 transition-opacity duration-200" data-src="/intro.mp4" preload="none" controls playsinline>
                <track kind="subtitles" src="/intro-en.vtt" srclang="en" label="English" default />
              </video>
            </div>
          </div>
        </dialog>
      </section>

      <!-- One flow: headline → video → single narrative (steps with “what you get” folded in) -->
      <section id="how-it-works" class="border-t border-base-300 bg-base-200 pt-12 md:pt-16 pb-16 md:pb-20">
        <div class="max-w-3xl mx-auto px-6">
          <p class="text-center text-xs uppercase tracking-widest text-base-content/50 mb-8">How it works</p>
          <h2 class="text-3xl md:text-5xl font-bold leading-tight mb-5 text-center" style="font-family: var(--font-moi-display), 'Fraunces', serif;">
            Create in seconds.<br />
            Track everything live.
          </h2>
          <p class="text-lg md:text-xl text-base-content/80 leading-relaxed text-center mb-16">
            One link for guests. Real-time totals. No spreadsheets.
          </p>

          <div class="max-w-2xl mx-auto mb-20">
            <div
              id="intro-video-trigger"
              class="group block w-full overflow-hidden border border-base-300 bg-base-100 shadow-2xl focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-base-200"
              role="button"
              tabindex="0"
              aria-label="Intro video: click to watch in popup"
            >
              <div class="relative aspect-video w-full bg-base-300 flex items-center justify-center overflow-hidden">
                <Image src={thumb} alt="" class="w-full h-full object-cover object-top-left" loading="lazy" width={1280} height={720} />
                <span class="absolute inset-0 flex items-center justify-center">
                  <span class="flex h-16 w-16 items-center justify-center rounded-full bg-primary text-primary-content shadow-xl transition-transform group-hover:scale-110" data-play-icon aria-hidden="true">
                    <svg class="w-7 h-7 ml-1" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z" /></svg>
                  </span>
                </span>
              </div>
              <p class="text-sm text-base-content/60 py-3 px-4 text-center border-t border-base-300">Watch 1-min intro</p>
            </div>
          </div>

          <!-- Single column: each step is one beat, “what you get” is part of the same beat -->
          <ol class="relative list-none p-0 m-0 space-y-0">
            {HOW_IT_WORKS.map((step, i) => {
              const getLine = [
                'No passwords. Your live dashboard is ready in seconds.',
                'One link for everyone—share via WhatsApp, SMS, or QR.',
                'Live totals, UPI & gifts in one place. Export anytime.',
              ][i];
              return (
                <li class="relative pl-16 pb-16 last:pb-0">
                  {i < HOW_IT_WORKS.length - 1 && (
                    <span class="absolute left-7 top-14 bottom-0 w-px bg-primary/30" aria-hidden="true"></span>
                  )}
                  <div class="absolute left-0 top-0.5 w-14 h-14 flex items-center justify-center rounded-full bg-primary text-primary-content font-bold text-xl">
                    {step.step}
                  </div>
                  <h3 class="font-semibold text-xl text-base-content mb-2">{step.title}</h3>
                  <p class="text-base text-base-content/80 leading-relaxed mb-3">{step.description}</p>
                  <p class="text-sm text-primary/90 font-medium">{getLine}</p>
                </li>
              );
            })}
          </ol>
          <div class="text-center pt-8">
            <a
              href={signupUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center justify-center px-8 py-4 bg-primary text-primary-content font-semibold text-sm uppercase tracking-wider hover:bg-primary/90 transition-colors"
            >
              Get started free
            </a>
            <p class="mt-6 text-sm text-base-content/50">Free to use · No credit card · No spam</p>
          </div>
        </div>
      </section>

      <div class="border-t border-base-300 py-6 text-center">
        <p class="text-xs text-base-content/40">Built for Indian weddings and celebrations</p>
      </div>
    </main>

    <Footer />

    <script>
      (function () {
        function initVideoModal() {
          const modal = document.getElementById('intro-video-modal');
          const content = document.getElementById('intro-video-dialog-content');
          const trigger = document.getElementById('intro-video-trigger');
          const player = document.getElementById('intro-video-player');
          const loadingEl = document.getElementById('intro-video-loading');
          if (!modal || !content || !trigger || !player) return;
          if (trigger.dataset.videoModalInited === 'true') return;
          trigger.dataset.videoModalInited = 'true';

          function showLoading() {
            if (loadingEl) { loadingEl.classList.remove('hidden'); }
            player.classList.add('opacity-0');
          }
          function hideLoadingAndPlay() {
            if (loadingEl) { loadingEl.classList.add('hidden'); }
            player.classList.remove('opacity-0');
            player.currentTime = 0;
            player.play().catch(function () {});
          }

          function openModal() {
            modal.showModal();
            if (!player.src || player.src === '' || player.src === window.location.href) {
              showLoading();
              player.src = player.dataset?.src || '/intro.mp4';
              player.load();
              player.addEventListener('canplay', function onCanPlay() {
                player.removeEventListener('canplay', onCanPlay);
                hideLoadingAndPlay();
              }, { once: true });
              player.addEventListener('error', function () {
                if (loadingEl) { loadingEl.querySelector('p').textContent = 'Could not load video.'; }
              }, { once: true });
            } else {
              hideLoadingAndPlay();
            }
          }

          trigger.addEventListener('click', openModal);
          trigger.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              openModal();
            }
          });

          modal.addEventListener('click', function (e) {
            if (!content.contains(e.target)) modal.close();
          });
          modal.addEventListener('close', function () {
            player.pause();
            player.currentTime = 0;
          });
        }

        document.addEventListener('astro:page-load', initVideoModal);
        initVideoModal();
      })();
    </script>


    <style is:global>
      #hero-section h1,
      #how-it-works h2,
      main section:last-of-type h2 { --font-moi-display: 'Fraunces', serif; }
    </style>
  </body>
</html>
