---
import { Image } from 'astro:assets';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';
import { SITE_DESCRIPTION, SITE_TITLE, FEATURES, HOW_IT_WORKS, getAppUrl } from '../consts';
import { generateSoftwareApplicationSchema, generateWebPageSchema } from '../seo';
import thumb from '../assets/thumb.jpg';

const signupUrl = getAppUrl('/signup', Astro.url);
const canonicalUrl = new URL(Astro.url.pathname, Astro.site).toString();

const softwareAppSchema = generateSoftwareApplicationSchema();
const webPageSchema = generateWebPageSchema(
  canonicalUrl,
  SITE_TITLE,
  SITE_DESCRIPTION
);

// Top 3 benefits for hero / social proof
const BENEFITS = FEATURES.slice(0, 3);
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead 
      title={SITE_TITLE} 
      description={SITE_DESCRIPTION} 
      schema={[softwareAppSchema, webPageSchema]}
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,400;0,9..144,600;0,9..144,700;1,9..144,400&display=swap" rel="stylesheet" />
  </head>
  <body class="min-h-screen flex flex-col bg-base-100 font-sans">
    <Header />

    <main class="flex-1">
      <!-- Hero -->
      <section id="hero-section" class="relative overflow-hidden min-h-[88vh] flex items-center">
        <div class="absolute inset-0 bg-linear-to-b from-base-100 via-base-100 to-base-200/50"></div>
        <div class="absolute inset-0 bg-[radial-gradient(ellipse_80%_50%_at_50%_-20%,oklch(76.88%_0.17_81/.12),transparent)]"></div>
        <canvas id="dot-grid" class="absolute inset-0 w-full h-full z-1 pointer-events-none" aria-hidden="true"></canvas>

        <div class="max-w-4xl mx-auto px-6 py-24 relative z-10 text-center">
          <p class="text-xs uppercase tracking-[0.25em] text-primary font-medium mb-6" style="font-family: var(--font-moi-display), 'Fraunces', serif;">
            Gift tracking for weddings & celebrations
          </p>
          <h1 class="text-5xl sm:text-6xl md:text-7xl font-bold tracking-tight leading-[1.05] mb-6" style="font-family: var(--font-moi-display), 'Fraunces', serif;">
            Track every contribution.<br />
            <span class="text-primary italic font-normal">Never miss a மொய்.</span>
          </h1>
          <p class="text-lg md:text-xl text-base-content/70 leading-relaxed mb-10 max-w-2xl mx-auto">
            One link. Real-time totals. UPI, cash, and gifts in one place. Share with family, export when you need it.
          </p>
          <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <a
              href={signupUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center justify-center px-8 py-4 bg-primary text-primary-content font-semibold text-sm uppercase tracking-wider hover:bg-primary/90 transition-all hover:scale-[1.02] focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-base-100"
            >
              Get started free
            </a>
            <a
              href="#how-it-works"
              class="inline-flex items-center justify-center px-8 py-4 border border-base-content/25 text-sm font-medium hover:border-primary hover:text-primary transition-colors"
            >
              See how it works
            </a>
          </div>
        </div>

        <dialog id="intro-video-modal" class="backdrop:bg-black/70 bg-transparent p-0 border-none w-full max-w-none">
          <div class="min-h-screen w-full px-4 py-10 flex items-center justify-center">
            <div id="intro-video-dialog-content" class="w-full max-w-4xl bg-base-100 border border-base-300 shadow-2xl">
              <video id="intro-video-player" class="w-full h-auto" data-src="/intro.mp4" controls playsinline autoplay></video>
            </div>
          </div>
        </dialog>

        <script is:inline>
          document.addEventListener('DOMContentLoaded', function() {
            var trigger = document.getElementById('intro-video-trigger');
            var modal = document.getElementById('intro-video-modal');
            var player = document.getElementById('intro-video-player');
            var dialogContent = document.getElementById('intro-video-dialog-content');
            if (!trigger || !modal || !player || !dialogContent) return;
            function resetPlayer() {
              player.pause();
              player.currentTime = 0;
              player.removeAttribute('src');
              player.load();
            }
            trigger.addEventListener('click', function() {
              if (!player.getAttribute('src')) {
                player.setAttribute('src', player.dataset.src || '');
                player.load();
              }
              modal.showModal();
            });
            modal.addEventListener('click', function(e) {
              if (!dialogContent.contains(e.target)) modal.close();
            });
            modal.addEventListener('close', resetPlayer);
          });
        </script>
      </section>

      <!-- One flow: headline → video → single narrative (steps with “what you get” folded in) -->
      <section id="how-it-works" class="border-t border-base-300 bg-base-200 pt-12 md:pt-16 pb-16 md:pb-20">
        <div class="max-w-3xl mx-auto px-6">
          <p class="text-center text-xs uppercase tracking-widest text-base-content/50 mb-8">How it works</p>
          <h2 class="text-3xl md:text-5xl font-bold leading-tight mb-5 text-center" style="font-family: var(--font-moi-display), 'Fraunces', serif;">
            Create in seconds.<br />
            Track everything live.
          </h2>
          <p class="text-lg md:text-xl text-base-content/80 leading-relaxed text-center mb-16">
            One link for guests. Real-time totals. No spreadsheets.
          </p>

          <div class="max-w-2xl mx-auto mb-20">
            <button
              id="intro-video-trigger"
              type="button"
              aria-label="Play intro video"
              aria-haspopup="dialog"
              aria-controls="intro-video-modal"
              class="group block w-full overflow-hidden border border-base-300 bg-base-100 shadow-2xl focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:ring-offset-base-200"
            >
              <div class="relative aspect-video w-full bg-base-300 flex items-center justify-center overflow-hidden">
                <Image src={thumb} alt="" class="w-full h-full object-cover object-top-left" loading="lazy" width={1280} height={720} />
                <span class="absolute inset-0 flex items-center justify-center">
                  <span class="flex h-16 w-16 items-center justify-center rounded-full bg-primary text-primary-content shadow-xl transition-transform group-hover:scale-110" aria-hidden="true">
                    <svg class="w-7 h-7 ml-1" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z" /></svg>
                  </span>
                </span>
              </div>
              <p class="text-sm text-base-content/60 py-3 px-4 text-center border-t border-base-300">Watch 1-min intro</p>
            </button>
          </div>

          <!-- Single column: each step is one beat, “what you get” is part of the same beat -->
          <ol class="relative list-none p-0 m-0 space-y-0">
            {HOW_IT_WORKS.map((step, i) => {
              const getLine = [
                'No passwords. Your live dashboard is ready in seconds.',
                'One link for everyone—share via WhatsApp, SMS, or QR.',
                'Live totals, UPI & gifts in one place. Export anytime.',
              ][i];
              return (
                <li class="relative pl-16 pb-16 last:pb-0">
                  {i < HOW_IT_WORKS.length - 1 && (
                    <span class="absolute left-7 top-14 bottom-0 w-px bg-primary/30" aria-hidden="true"></span>
                  )}
                  <div class="absolute left-0 top-0.5 w-14 h-14 flex items-center justify-center rounded-full bg-primary text-primary-content font-bold text-xl">
                    {step.step}
                  </div>
                  <h3 class="font-semibold text-xl text-base-content mb-2">{step.title}</h3>
                  <p class="text-base text-base-content/80 leading-relaxed mb-3">{step.description}</p>
                  <p class="text-sm text-primary/90 font-medium">{getLine}</p>
                </li>
              );
            })}
          </ol>
          <div class="text-center pt-8">
            <a
              href={signupUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center justify-center px-8 py-4 bg-primary text-primary-content font-semibold text-sm uppercase tracking-wider hover:bg-primary/90 transition-colors"
            >
              Get started free
            </a>
            <p class="mt-6 text-sm text-base-content/50">Free to use · No credit card · No spam</p>
          </div>
        </div>
      </section>

      <div class="border-t border-base-300 py-6 text-center">
        <p class="text-xs text-base-content/40">Built for Indian weddings and celebrations</p>
      </div>
    </main>

    <Footer />

    <script is:inline>
      (function() {
        var canvas = document.getElementById('dot-grid');
        if (!canvas) return;
        var ctx = canvas.getContext('2d');
        var heroSection = document.getElementById('hero-section');
        var DOT_SPACING = 40;
        var BASE_RADIUS = 1;
        var MAX_RADIUS = 4;
        var BASE_ALPHA = 0.06;
        var MAX_ALPHA = 0.5;
        var INFLUENCE_RADIUS = 100;
        var LERP_FACTOR = 0.1;
        var PRIMARY = { r: 234, g: 179, b: 8 };
        var BASE = { r: 255, g: 255, b: 255 };
        var mouseX = -1000, mouseY = -1000, dots = [], animationId = null, isVisible = true;

        function createDots() {
          dots = [];
          var cols = Math.ceil(canvas.width / DOT_SPACING) + 1;
          var rows = Math.ceil(canvas.height / DOT_SPACING) + 1;
          for (var r = 0; r < rows; r++)
            for (var c = 0; c < cols; c++)
              dots.push({
                x: c * DOT_SPACING,
                y: r * DOT_SPACING,
                currentRadius: BASE_RADIUS,
                currentAlpha: BASE_ALPHA,
                currentColor: { r: BASE.r, g: BASE.g, b: BASE.b }
              });
        }
        function lerp(a, b, t) { return a + (b - a) * t; }
        function resizeCanvas() {
          var rect = heroSection.getBoundingClientRect();
          var dpr = window.devicePixelRatio || 1;
          canvas.width = rect.width * dpr;
          canvas.height = rect.height * dpr;
          canvas.style.width = rect.width + 'px';
          canvas.style.height = rect.height + 'px';
          ctx.scale(dpr, dpr);
          createDots();
        }
        function updateDot(dot) {
          var dx = mouseX - dot.x, dy = mouseY - dot.y;
          var d = Math.sqrt(dx * dx + dy * dy);
          var targetR = BASE_RADIUS, targetA = BASE_ALPHA, targetC = { r: BASE.r, g: BASE.g, b: BASE.b };
          if (d < INFLUENCE_RADIUS) {
            var inf = 1 - d / INFLUENCE_RADIUS;
            inf = inf * inf;
            targetR = BASE_RADIUS + (MAX_RADIUS - BASE_RADIUS) * inf;
            targetA = BASE_ALPHA + (MAX_ALPHA - BASE_ALPHA) * inf;
            targetC = {
              r: BASE.r + (PRIMARY.r - BASE.r) * inf,
              g: BASE.g + (PRIMARY.g - BASE.g) * inf,
              b: BASE.b + (PRIMARY.b - BASE.b) * inf
            };
          }
          dot.currentRadius = lerp(dot.currentRadius, targetR, LERP_FACTOR);
          dot.currentAlpha = lerp(dot.currentAlpha, targetA, LERP_FACTOR);
          dot.currentColor.r = lerp(dot.currentColor.r, targetC.r, LERP_FACTOR);
          dot.currentColor.g = lerp(dot.currentColor.g, targetC.g, LERP_FACTOR);
          dot.currentColor.b = lerp(dot.currentColor.b, targetC.b, LERP_FACTOR);
        }
        function drawDot(dot) {
          var c = dot.currentColor;
          ctx.beginPath();
          ctx.arc(dot.x, dot.y, dot.currentRadius, 0, Math.PI * 2);
          ctx.fillStyle = 'rgba(' + Math.round(c.r) + ',' + Math.round(c.g) + ',' + Math.round(c.b) + ',' + dot.currentAlpha + ')';
          ctx.fill();
        }
        function animate() {
          if (!isVisible) { animationId = requestAnimationFrame(animate); return; }
          var rect = heroSection.getBoundingClientRect();
          ctx.clearRect(0, 0, rect.width, rect.height);
          for (var i = 0; i < dots.length; i++) { updateDot(dots[i]); drawDot(dots[i]); }
          animationId = requestAnimationFrame(animate);
        }
        function onMove(e) {
          var rect = heroSection.getBoundingClientRect();
          mouseX = e.clientX - rect.left;
          mouseY = e.clientY - rect.top;
        }
        function onLeave() { mouseX = -1000; mouseY = -1000; }
        var observer = new IntersectionObserver(function(entries) {
          entries.forEach(function(e) { isVisible = e.isIntersecting; });
        }, { threshold: 0 });
        resizeCanvas();
        observer.observe(heroSection);
        heroSection.addEventListener('mousemove', onMove);
        heroSection.addEventListener('mouseleave', onLeave);
        window.addEventListener('resize', resizeCanvas);
        animate();
        document.addEventListener('astro:before-swap', function() {
          if (animationId) cancelAnimationFrame(animationId);
          observer.disconnect();
          heroSection.removeEventListener('mousemove', onMove);
          heroSection.removeEventListener('mouseleave', onLeave);
          window.removeEventListener('resize', resizeCanvas);
        });
      })();
    </script>
    <style is:global>
      #hero-section h1,
      #how-it-works h2,
      main section:last-of-type h2 { --font-moi-display: 'Fraunces', serif; }
    </style>
  </body>
</html>
